name: æ„å»º Caddy æ’ä»¶ç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v2.10.0)'
        required: true
        type: string
      plugins:
        description: 'æ’ä»¶åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªæ’ä»¶)'
        required: true
        type: string
        default: |
          github.com/caddyserver/caddy/v2
          github.com/mholt/caddy-ratelimit
          github.com/lanrat/caddy-dynamic-remoteip
          github.com/greenpau/caddy-security
          github.com/caddy-dns/cloudflare

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64
            ext: .exe
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'
        
    - name: å®‰è£… xcaddy
      run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
      
    - name: å‡†å¤‡æ’ä»¶å‚æ•°
      id: prepare
      run: |
        plugins="${{ inputs.plugins }}"
        with_args=""
        while IFS= read -r line; do
          if [ -n "$line" ] && [[ ! "$line" =~ ^[[:space:]]*$ ]]; then
            with_args="$with_args --with $line"
          fi
        done <<< "$plugins"
        echo "with_args=$with_args" >> $GITHUB_OUTPUT
        
    - name: æ„å»º Caddy (${{ matrix.suffix }})
      run: |
        xcaddy build ${{ steps.prepare.outputs.with_args }}
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        
    - name: é‡å‘½åå¹¶æ£€æŸ¥æ–‡ä»¶
      run: |
        if [ "${{ matrix.goos }}" = "windows" ]; then
          if [ -f "caddy.exe" ]; then
            mv caddy.exe caddy-${{ matrix.suffix }}.exe
          elif [ -f "caddy" ]; then
            mv caddy caddy-${{ matrix.suffix }}.exe
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ°æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶"
            ls -la
            exit 1
          fi
        else
          if [ -f "caddy" ]; then
            mv caddy caddy-${{ matrix.suffix }}
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ°æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶"
            ls -la
            exit 1
          fi
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: caddy-${{ matrix.suffix }}${{ matrix.ext }}
        path: caddy-${{ matrix.suffix }}${{ matrix.ext }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: å‡†å¤‡å‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        plugins="${{ inputs.plugins }}"
        echo "## ğŸš€ Caddy è‡ªå®šä¹‰æ„å»ºç‰ˆæœ¬" > release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“¦ åŒ…å«çš„æ’ä»¶:" >> release_notes.md
        while IFS= read -r line; do
          if [ -n "$line" ] && [[ ! "$line" =~ ^[[:space:]]*$ ]]; then
            echo "- \`$line\`" >> release_notes.md
          fi
        done <<< "$plugins"
        echo "" >> release_notes.md
        echo "### ğŸ’» æ”¯æŒçš„æ¶æ„:" >> release_notes.md
        echo "- Linux AMD64" >> release_notes.md
        echo "- Linux ARM64" >> release_notes.md
        echo "- Windows AMD64" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“¥ ä¸‹è½½è¯´æ˜:" >> release_notes.md
        echo "è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿæ¶æ„é€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ã€‚" >> release_notes.md
        
    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.version }}
        name: Caddy æ„å»ºç‰ˆæœ¬ ${{ inputs.version }}
        body_path: release_notes.md
        files: |
          caddy-linux-amd64/caddy-linux-amd64
          caddy-linux-arm64/caddy-linux-arm64
          caddy-windows-amd64.exe/caddy-windows-amd64.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
